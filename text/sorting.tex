\documentclass{article}
\usepackage{amsmath, amsfonts, amsthm, amssymb,fullpage}
%\usepackage{sagetex}
\usepackage{comment}
\usepackage{hyperref}
\usepackage{color}
\definecolor{mylinkcolor}{rgb}{0.5,0.0,0.0}
\definecolor{myurlcolor}{rgb}{0.0,0.0,0.75}
\hypersetup{colorlinks=true,urlcolor=myurlcolor,citecolor=myurlcolor,linkcolor=mylinkcolor,linktoc=page,breaklinks=true}

\newtheorem{thm}{Theorem}[section]
\newtheorem{cor}[thm]{Corollary}
\newtheorem{lem}[thm]{Lemma}
\newtheorem{prop}[thm]{Proposition}
\newtheorem{defn}{Definition}%[section]
\newtheorem{rem}[thm]{Remark}

\def\Sage{{\tt Sage}}
\def\Z{{\mathbb Z}}
\def\Q{{\mathbb Q}}
\def\R{{\mathbb R}}
\def\C{{\mathbb C}}
\def\T{{\mathbb T}}
\def\H{{\mathbb H}}
%\def\RC{{K_\infty}}
\def\RC{{\tilde{K}}}
\def\P{{\mathbb P}}
\def\F{{\mathbb F}}
\def\Fp{{\mathbb F}_p}
\def\Fq{{\mathbb F}_q}
\def\M{{\mathcal M}}
\def\CC{{\mathcal C}}
\def\HH{{\mathcal H}}
\def\SS{{\mathcal S}}
\def\G{{\mathcal G}}
\def\K{{\mathcal K}}
\def\I{{\mathcal I}}
\def\J{{\mathcal J}}
\def\PP{{\mathcal P}}
\def\OO{{\mathcal O}}
\def\ZG{{\mathcal Z}}
\def\a{{\mathfrak a}}
\def\b{{\mathbf b}}

\def\v{{\mathbf v}}
%\def\c{{\mathfrak c}}
\def\d{{\mathfrak d}}
\def\D{{\mathfrak D}}
\def\m{{\mathfrak m}}
\def\n{{\mathfrak n}}
\def\N{{\mathfrak N}}
\def\p{{\mathfrak p}}
\def\q{{\mathfrak q}}
\def\r{{\mathfrak r}}
\def\u{{\mathfrak u}}
\def\DF{{\nabla\underline{F}}}
\def\Qbar{\overline{\Q}}
\def\Qpbar{\overline{\Q_p}}
\def\Abar{\overline{A}}
\def\RR{{R\oplus R}}
\def\KK{{K\oplus K}}
\def\uF{{\underline{F}}}
\def\oC{\overline{\mathcal C}}
\def\oP{\overline{P}}
\def\oM{\overline{M}}
\DeclareMathOperator{\lcm}{lcm}
\DeclareMathOperator{\disc}{disc}
\DeclareMathOperator{\rk}{rank}
\DeclareMathOperator{\ord}{ord}
\DeclareMathOperator{\diag}{diag}
\DeclareMathOperator{\adj}{adj}
\DeclareMathOperator{\Mat}{Mat}
\DeclareMathOperator{\Hom}{Hom}
\DeclareMathOperator{\Res}{Res}
\DeclareMathOperator{\Gal}{Gal}
\DeclareMathOperator{\End}{End}
\DeclareMathOperator{\Aut}{Aut}
\DeclareMathOperator{\Cl}{Cl}
\def\<#1>{\left<#1\right>}
\newcommand{\mat}[4]{\left(\begin{matrix} %
                   #1 & #2 \\ #3 & #4 %
                  \end{matrix}\right)}
\newcommand{\smat}[4]{\left(\begin{smallmatrix} %
                   #1 & #2 \\ #3 & #4 %
                  \end{smallmatrix}\right)}
\DeclareMathOperator{\im}{im}


\title{Notes on sorting number field elements, prime ideals\\and
  isogenous elliptic curves over number fields}
\author{John Cremona, Aurel Page, and Andrew V. Sutherland}

\begin{document}
\maketitle

These notes concern algorithms for sorting different objects:
algebraic numbers, prime ideals of a fixed number field, and elliptic
curves in an isogeny class over a number field.

\section{Sorting number field elements}
\subsection{Defining the number field}
We assume that every number field $K$ is given in the form
$K=\Q(\alpha)$ where $\alpha$ is an algebraic integer whose
minimal polynomial $g(X)$ is canonically determined by the field $K$.
In practice, $g(X)$ is the
polynomial returned by the {\tt Pari} function {\tt polredabs} which
is guaranteed to always return the same polynomial, given any
polynomial defining a number field isomorphic to $K$.  This canonical
polynomial $g(X)$ is thus fixed one and for all; it is monic and
integral.

We do not assume that $\Z[\alpha]$ is the full ring of integers
$\OO_K$.  Indeed, for most number fields $K$ this condition is
not satisfied by any choice of $\alpha$ (in general the ring $\OO_K$
will not be monogenic over $\Z$).

We emphasize that both the defining polynomial $g(X)$ and the generator
$\alpha$ of~$K$ are fixed.  In other words we are fixing the structure
of $K=\Q[X]/(g(X))$ not just as a field, but as a $\Q[X]$-algebra, where the
structure map $\Q[X]\to K$ has kernel $(g(X))$ and $\alpha$ is the
image of $X$ in $K$.

\subsection{Ordering the elements of a fixed number field}\label{sec:ordfix}
Given $K=\Q(\alpha)$ as above, with degree $d=[K:\Q]=\deg f$, every
element $\beta\in K$ can be uniquely expressed as a polynomial in
$\alpha$ of degree at most $d-1$, say
$\beta=\sum_{i=0}^{d-1}b_i\alpha^i$, and we use the coefficient vector
$(b_0,b_1,\dots,b_{d-1})\in\Q^d$ as a sorting key, where $\Q^d$ is
sorted lexicographically.  To remove any ambiguity, if
$\gamma=\sum_{i=0}^{d-1}c_i\alpha^i$ then $\beta<\gamma$ if and only
if we have $b_i<c_i$ for the \textit{least} index~$i$ such that $b_i\not=c_i$.

The induced ordering on $\Q$ viewed as a subset of $K$
is the same as the standard ordering of $\Q$

\subsection{An incomplete alternative sorting method}

If $\beta$ and $\gamma$ are algebraic numbers contained in a number
field $K$ then we may order them as above, but we should note that
this ordering depend on $K$ (and our fixed representation $K=\Q(\alpha)$).
The order may change if we enlarge $K$; for example, in the field
$K=\Q(\alpha):=\Q[X]/(X^3-X^2+1)$ we have $\alpha-\alpha^2 < \alpha$
(because $(0,1,-1) < (0,1,0)$), but if
embed $K$ in its Galois closure $$L=\Q(\beta):=\Q[X]/(X^6 - 3X^5 + 5X^4 - 5X^3 + 5X^2 - 3X + 1)$$
via the map $\pi:K\to L$ defined by  $\pi(\alpha) = \beta^5 - 2\beta^4 + 2\beta^3 - \beta^2 + 2\beta$,
in the field $L$ we have $\pi(\alpha-\alpha^2) > \pi(\alpha)$
(because $(2,-4,5,-5,3,-1)>(0,2,-1,2,-2,1)$).

It is tempting to try to define an ordering on $\Qbar$ that would
allow us to consistently order all algebraic numbers, independent
of a choice an ambient number field.  Every $\beta\in\Qbar$ is a root of a
unique irreducible primitive polynomial $g(X)\in\Z[X]$  with positive
leading coefficient.  Using the coefficient sequence
of $g$ as a key, we can unambiguously  compare any two non-conjugate algebraic
numbers. By first sorting on $\deg(g)$ we can ensure that algebraic numbers of
lower degree come before those of higher degree.

However, to obtain a total order on $\Qbar$ we must also specify
an ordering of each set of Galois conjugates, algebraic numbers
that are roots of the same polynomial $g(X)$.  This could be done, for example, by fixing an
embedding of $\Qbar$ into $\C$ and representing elements of $\C$ as
vectors in $\R^2$ ordered lexicographically. But to apply this ordering to
elements of a number field $K=\Q(\alpha)$ would require fixing an
embedding of every such $K$ into $\Qbar$ in a way that is compatible
with respect to inclusion.  This may be possible but it
is certainly not easy to defined and implement.

On balance we decided to use the ordering defined in \S\ref{sec:ordfix}, which allows us to compare algebraic numbers only as elements of a chosen ambient field with a fixed defining polynomial and generator.

\section{Sorting prime ideals}\label{sec:primes}
Fix a number field $K=\Q(\alpha)=\Q[X]/(g(X))$ with defining polynomial
$g\in\Z[X]$ and generator $\alpha$ as above, and let $\OO_K$ denote its ring of integers.
We do not assume that $K/\Q$ is Galois or that $\OO_K=\Z[\alpha]$.
By a \emph{prime} of $K$ (or of $\OO_K$) we mean a prime ideal in the ring $\OO_K$; for primes of $\Q$ we may also use $p$ to denote the prime ideal $(p)$.

We wish to define a total order on the set of prime ideals~$\p$
of $\OO_K$.  Let $(p)=\p\cap \Z$ be the prime of $\Z$ lying below $\p$,
let $e=e(\p/p)$ be the ramification index (the multiplicity of $\p$ in the prime factorization of $(p)$ in the Dedekind domain $\OO_K$), and let $f=f(\p/p)$ the residue field degree $[\OO_K/\p:\F_p]$.
The (absolute) norm of $\p$ is then $N(\p)=p^f$.

In \Sage, if $\p=${\tt P} is the prime ideal then its norm is
$N(\p)=${\tt P.norm()}, the underlying prime $p$ can be computed as $p=${\tt
 P.smallest\_integer()}, the
ramification index is $e=${\tt P.ramification\_index()}, and the residue degree is $f=${\tt
  P.residue\_class\_degree()}.

We order the primes $\p$ first by norm and then by the ramification index.
It remains only to order the primes~$\p$ of $K$ that lie above the same rational prime $p$ and have the same norm (hence the same residue degree) and ramification index.  Such primes will necessarily have the same value of $p^{ef}$; the converse need not hold (primes with the same value of $p^{ef}$ need not have the same norm), but this will not concern us since we order by norm first.

\subsection{The case of unramified primes}

Our general method is simplest when $p$ is unramified, not just in $K$
but in the order $\Z[\alpha]$; this holds precisely when $p\nmid [\OO_K:\Z[\alpha]]\disc(K)$, equivalently, $p^2\nmid\disc(g)$, which applies to all but finitely many $p$.  In this case $g(X)$ factors modulo~$p$ into distinct irreducible elements of $\Fp[X]$, and we may
write
\[
    g(X) \equiv \prod_i h_i(X) \pmod{p},
\]
with the factors $h_i(X)\in\Z[X]$ monic and such that their reductions
modulo~$p$ are distinct and irreducible.  We may assume that the
coefficients of each $h_i(X)$ are reduced modulo~$p$ to integers in the interval $[0,p-1]$, and we order these factors first by degree and then lexicographically by their coefficient vectors in $[0,p-1]^f$.

The Dedekind-Kummer theorem allows us to associate to each factor
$h_i(X)$ the prime ideal $\p_i=(p,h_i(\alpha))$ above $p$, with
residue degree $f(\p_i/p)=\deg h_i$ and norm $N(\p_i)=p^{\deg h_i}$.
We then have $p\OO_K=\prod_i \p_i$ and our ordering of the $h_i$
induces an ordering of the primes~$\p_i$ above $p$.  If we have any
representation of $\p_i$ in the form $\p_i=(p,\beta)$ where
$\beta=b(\alpha)$ for some $b(X)\in\Z[X]$, then we can recover
$h_i(X)$ since $h_i(X)=\gcd(g(X),b(X))$ (with the $\gcd$ computed in
$\F_p[X]$).  This follows from the observation that
$\ord_{\p_i}(\beta)>0$ while $\ord_{\p_j}(\beta)=0$ for all primes
$\p_j$ above~$p$ other than~$\p_i$.  This makes implementation of the
sorting function on the primes above~$p$ very simple in this case.

\subsection{The general case, including ramified and unramified primes}

There is a bijection between the distinct primes $\p$ above $p$ and
the irreducible factors $h(X)$ of $g(X)$ in $\Q_p[X]$ in which $\deg h
= e(\p/p)f(\p/p)$ \cite[Theorem 3.8 (d)]{Janusz}.  Write
\[
  g(X) = h_1(X)h_2(X)\dots h_r(X)
\]
with the $h_i(X)$ monic and irreducible in $\Z_p[X]$. Since we sort prime ideals
by norm and ramification index, it is enough to describe an order on polynomials
of the same degree (in fact we are interested only in those polynomials $h_i(X)$
that not only have the same degree, but correspond to primes $\p_i$ with the same
ramification index and residue degree, which may be a proper subset).

We sort polynomials in~$\Z_p[X]$ of degree~$d$ as follows. Such a polynomial~$P$
can be written in the form
\[
  (a_{0,0}+a_{0,1}p+a_{0,2}p^2+\dots) + (a_{1,0}+a_{1,1}p+\dots)X
  + \dots + (a_{d,0}+a_{d,1}p+\dots)X^d,
\]
with and~$a_{i,j}\in\Z\cap[0,p-1]$. We can then attach to~$P$ the infinite
vector
\[
(a_{0,0},a_{1,0},\dots,a_{d,0},a_{0,1},a_{1,1},\dots,a_{d,1},a_{0,2},\dots)\in [0,p-1]^\infty,
\]
and we sort polynomials according to the lexicographic ordering of such vectors.
Comparisons can be made using finite precision, provided that the polynomials are known to be
distinct, which is the case for the~$h_i$.

%In what follows it will be sufficient to know the
%$h_i$ to finite $p$-adic precision.
%Let $k\ge1$ be an integer such that the $f_i(X)$ are distinct
%modulo~$p^k$.  We may take $k=1$ if and only if $p$ is unramified (in
%the sense that it does not divide $\disc f$).  Denote by $h_i^k(X)$
%the unique monic polynomial in $\Z[X]$ with coefficients $c$
%satisfying $0\le c\le p^k-1$ which is congruent to $h_i(X)\pmod{p^k}$.
%Then the ordering of the $h_i(X)$ of the same degree defined in the
%previous paragraph as the same as the ordering of the $h_i^k(X)$ by
%lexicographical ordering of their integer coefficient vectors.

We now explain how to compute the bijection between the~$h_i$ and the primes
above~$p$. Let~$h\in\Z_p[X]$ be one of the~$h_i$, and let~$\p$ be a prime
above~$p$. The valuation~$v_{\p}$ on the number field~$K$ (a finite \'etale $\Q$-algebra) extends to the \'etale $\Q_p$-algebra ~$K\otimes_{\Q}\Q_p = \prod_i
\Q_p[X]/(h_i(X))$ obtained via base-change in the following way.
Let~$j$ be such that~$h_{j}$ corresponds
to~$\p$, and let~$v_j$ be the valuation of the $p$-adic field~$\Q_p[X]/(h_j(X))$.
Define the extension of~$v_\p$ to $K\otimes_\Q\Q_p$ to be the composition of the maps
\[
  K\otimes_{\Q}\Q_p \longrightarrow \Q_p[X]/(h_j(X)) \stackrel{v_j}{\longrightarrow} \Z\cup\{\infty\}.
\]
%by using the valuation on the factor corresponding to~$\p$,
%which is a $p$-adic field.
We then have~$v_{\p}(h(\alpha)) = \infty$ if and only
if~$\p$ corresponds to~$h$.
This valuation cannot be computed using finite
approximations to~$h$, however, for all integers~$k\ge 1$ we have~$v_\p((p^k,h(\alpha)))
= \min(e(\p/p)k, v_\p(h(\alpha)))$ equal to~$e(\p/p)k$
if~$h$ corresponds to~$\p$ and bounded above otherwise (independent of~$k$). The
valuation~$v_\p((p^k,h(\alpha)))$ can be computed using finite approximations
to~$h$, and if $k$ is such that the set $\{v_\p((p^k,h_i(\alpha)))\}$ has a unique maximum, this maximum occurs for the polynomial $h_i(X)$ corresponding to $\p$.
Thus we can compute the bijection by making $k$ sufficiently large (and any $k$ that yields a unique maximum works).

We remark that ``Round 4" of the $p$-adic polynomial factorization algorithm
implemented in \texttt{Pari} (and in \texttt{sage}?) \cite{Roblot}
computes the prime ideals corresponding to the various $p$-adic factors, but
this part of the output is not available via the standard interface.
The discussion above allows us to recover the bijection without requiring direct access to this implementation (which may not be the same on other computer algebra systems in any case).

%For each prime $\p\mid p$ there is a unique index~$i$ such that
%$\ord_{\p}(h_i^k(\alpha))$ is strictly greater than all other
%$\ord_{\p}(h_j^k(\alpha))$.  For example, in the unramified case when
%$k=1$, $\ord_{\p}(h_i^1(\alpha))>0$ for one value of~$i$, while
%$\ord_{\p}(h_j^1(\alpha))=0$ for $j\not=i$.  We prove this as follows:
%
%For each $i$ let $\alpha_i\in\Qpbar$ be a root of $h_i(X)$.  There are
%$g$ different embeddings of $K$ into $\Qpbar$, up to conjugacy,
%defined by mapping $\alpha$ to $\alpha_i$ for $1\le i\le g$.  Since
%$h_i(\alpha_i)=0$ while $h_i(\alpha_j)\not=0$ for $j\not=i$, we have
%that $\lim_{k\to\infty}h_i^k(\alpha_i)=0$ while
%$\lim_{k\to\infty}h_i^k(\alpha_j)\not=0$ for $j\not=0$.
%
%Each field $\Q_p(\alpha_i)$ is the completions $K_{\p_i}$ of $K$ at
%some prime~$\p_i$ above~$p$, and the absolute value in each
%$\Q_p(\alpha_i)$ is that induced by the $\p_i$-adic valuation on $K$
%and on $\Q_p(\alpha_i)$.  Hence the limits in the previous paragraph
%are equivalent to saying that
%\[
%    \lim_{k\to\infty}\ord_{\p_i}(h_i^k(\alpha)) = \infty,
%\]
%while $\ord_{\p_j}(h_i^k(\alpha))$ remains bounded as $k\to\infty$ for
%$j\not=i$.  Thus for large enough $k$, $\ord_{\p_i}(h_i^k(\alpha))$ is
%strictly greater that $\ord_{\p_i}(h_j^k(\alpha))$ for all $j\not=i$.
%We can use this fact to uniquely assigned one of the $h_i^k$ to each
%$\p_i$ and use the ordering of the $h_i$ defined above to order the
%$\p_i$.
%
%In order to implement this in practice we need to know how large value
%of $k$ is needed.  Is it sufficient for $k$ to be such that the sets
%$\{\ord_{\p_i}(h_j^k(\alpha)) \mid 1\le j\le g\}$ have a unique
%maximal element, for all~$i$?  If so we can start with some $k$ and
%increase it until this property holds.  This will be easier than
%deciding in advance which $k$ work, in terms of the $p$-adic valuation
%of $\disc f$ perhaps.

\subsection{Examples}
Let $K=\Q(\alpha)$ be non-Galois cubic field \href{www.lmfdb.org/NumberField/3.1.503.1}{\texttt{3.1.503.1}} of discriminant $-503$ with canonical defining polynomial $g(x)=X^3-X^2+2X+8$.
The prime $2$ is unramified, but it divides $\disc(g(X))=-2^2\cdot 503$ and is an essential divisor of $[\OO_K:\Z[\alpha]]$ in the sense that this is true for every algebraic integer $\alpha$ in $K$ (this example, due to Dedekind, is the standard example of a non-monogenic field).

Let $p=2$ and $k=2$; the $2$-adic factors of $g(X)$ are: $h_1=X+O(2^2)$,
$h_2=X+2+O(2^2)$, $h_3=X+1+O(2^2)$.  So there are $3$
primes above $2$, each with residue degree $1$.
Calling these $\p_a = (2,\frac 12\alpha^2+\frac 12\alpha+3)$, $\p_b =
(2,\alpha+3)$, $\p_c = (2,\frac 12\alpha^2-\frac 12\alpha)$ in random order we find that
\begin{itemize}
  \item the $\p_a$-valuations of the $(2^2,h_i(\alpha))$ are $(1,2,0)$,
  \item the $\p_b$-valuations of the $(2^2,h_i(\alpha))$ are $(0,0,2)$,
  \item the $\p_c$-valuations of the $(2^2,h_i(\alpha))$ are $(2,1,0)$,
\end{itemize}
thus $\p_1=\p_c$, $\p_2=\p_a$ and $\p_3=\p_b$.

Let $p=503$.  There are two primes above~$p$ both of norm~$p$, only
one of which is ramified (with $e=2$). Our ordering puts the
unramified prime first and the ramified prime second, so we do not even need to
look at the $p$-adic factorization of $g(X)$ in this case.  In fact,
with $k=2$ we find factors $X+191929+O(503^2)$ and $X^2+61079X+87617+O(503^2)$.

For a larger example, let $K=\Q(\alpha)=\Q[X]/(g(X))$, where
\[
g(X)= X^{10} - 3X^9 - 35X^8 + 120X^7 + 242X^6 - 1080X^5 + 44X^4 + 2343X^3 -
1631X^2 + 111X + 79.
\]
This field has LMFDB
label~\href{http://beta.lmfdb.org/NumberField/10.10.24952891341003125.1}{\texttt{10.10.24952891341003125.1}} and discriminant~$5^5 41^8$, but we have
\[
\disc(g)=3^{12}\cdot 5^5\cdot 41^8\cdot 2141^2\cdot 26641^2.
\]
Let us consider the primes above $3$.
Over~$\Q_3$, the polynomial $g(X)$ splits as
a product of~$5$ polynomials of degree~$2$, that is, $g = h_1h_2h_3h_4h_5$ with
$h_i\in\Z_3[x]$. Modulo~$3$, we have
\begin{itemize}
  \item $h_1 = X^2 + 1 +O(3)$,
  \item $h_2 = X^2 + 2X + 2 + O(3)$,
  \item $h_3 = X^2 + X + 2 + O(3)$,
  \item $h_4 = X^2 + 2X + 2 + O(3)$,
  \item $h_5 = X^2 + X + 2 + O(3)$.
\end{itemize}
The prime $3$ is unramified, so we can already see that it splits into 5 primes of norm $9$.  These approximations are not sufficient to distinguish all the $h_i$,
but we get the following initial segments of the associated vectors (omitting
the maximal degree term since they are all monic):
\begin{itemize}
  \item $(1,0,\dots)$,
  \item $(2,2,\dots)$,
  \item $(2,1,\dots)$,
  \item $(2,2,\dots)$,
  \item $(2,1,\dots)$,
\end{itemize}
so we have~$h_1 < h_3,h_5 < h_2,h_4$. Modulo~$9$, we get
\begin{itemize}
  \item $h_1 = X^2 + 3X + 1 + O(3^2)$,
  \item $h_2 = X^2 + 5X + 5 + O(3^2)$,
  \item $h_3 = X^2 + 7X + 2 + O(3^2)$,
  \item $h_4 = X^2 + 5X + 5 + O(3^2)$,
  \item $h_5 = X^2 + 4X + 5 + O(3^2)$.
\end{itemize}
This is still not enough to distinguish them, but
we get the refined initial segments
\begin{itemize}
  \item $(1,0,0,1,\dots)$,
  \item $(2,2,1,1,\dots)$,
  \item $(2,1,0,2,\dots)$,
  \item $(2,2,1,1,\dots)$,
  \item $(2,1,1,1,\dots)$,
\end{itemize}
so we have~$h_1<h_3<h_5<h_2,h_4$. Finally, modulo~$27$ we have
\begin{itemize}
  \item $h_1 = X^2 + 3X + 1 + O(3^3)$,
  \item $h_2 = X^2 + 5X + 5 + O(3^3)$,
  \item $h_3 = X^2 + 7X + 11 + O(3^3)$,
  \item $h_4 = X^2 + 23X + 23 + O(3^3)$,
  \item $h_5 = X^2 + 13X + 14 + O(3^3)$.
\end{itemize}
This is now enough to distinguish all the~$h_i$, and we obtain the initial segments
\begin{itemize}
  \item $(1,0,0,1,0,0\dots)$,
  \item $(2,2,1,1,0,0,\dots)$,
  \item $(2,1,0,2,1,0,\dots)$,
  \item $(2,2,1,1,2,2,\dots)$,
  \item $(2,1,1,1,1,1,\dots)$,
\end{itemize}
yielding the order~$h_1 < h_3 < h_5 < h_2 < h_4$.
As noted above, the prime~$3$ decomposes as a product of~$5$ prime ideals of norm~$9$,
which we denote~$\p_a, \dots, \p_e$ in arbitrary order. We know that we need
precision at least~$O(3^3)$ to distinguish the polynomials~$h_i$, so we compute
the valuations~$v_\p((3^3,h_i(\alpha)))$. We obtain:
\begin{itemize}
  \item The~$\p_a$-valuations of~$(3^3,h_i(\alpha))$ are~$(0,0,0,0,3)$,
  \item The~$\p_b$-valuations of~$(3^3,h_i(\alpha))$ are~$(0,3,0,2,0)$,
  \item The~$\p_c$-valuations of~$(3^3,h_i(\alpha))$ are~$(3,0,1,0,0)$,
  \item The~$\p_d$-valuations of~$(3^3,h_i(\alpha))$ are~$(0,2,0,3,0)$,
  \item The~$\p_e$-valuations of~$(3^3,h_i(\alpha))$ are~$(1,0,3,0,0)$,
\end{itemize}
thus we have the bijection~$\p_a\leftrightarrow h_5$, $\p_b\leftrightarrow h_2$,
$\p_c\leftrightarrow h_1$, $\p_d\leftrightarrow h_4$, $\p_e\leftrightarrow h_3$.
Since these ideals all have norm~$9$ and ramification index~$1$, our ordering of
the primes above~$3$ is~$\p_c < \p_e < \p_a < \p_b < \p_d$.

\section{Sorting all integral ideals}

Fix a number field $K=\Q(\alpha)$ with defining polynomial
$g(X)\in\Z[X]$ and generator $\alpha$ as above. 
We now define a total order on the set of all integral ideals of~$K$.
We always order ideals by norm, and then define some criteria to sort ideals of
the same norm. The order we choose will have the property that prime ideals are
smaller than every non-prime ideal of the same norm, and are ordered in the same
way as before.

\subsection{Ideals of prime power norm}\label{sec:primepowernorm}

We first define an order on the set of ideals of prime power norm. Let~$\a$ be
an ideal of norm~$p^n$, and let~$\p_1,\dots,\p_r$ be the prime ideals of~$K$
above~$p$, ordered as in Section~\ref{sec:primes}. We have~$\a = p_1^{v_1}\dots
p_g^{v_r}$ for some integers~$v_i\ge 0$. We define the weight of this
factorization to be~$v_1+\dots+v_r$. We order ideals of norm a power of $p$ by
increasing norm first, then increasing weight, and finally by reverse
lexicographic order of the vector of exponents~$(v_1,\dots,v_r)$. For this
order, the prime ideals come first, and are ordered in the same way as
previously.

Example: let~$K$ be a number field and~$p$ a prime number that decomposes in~$K$
as the product~$\p_1\p_2\p_3\p_4$ where~$\p_1$, $\p_2$ and~$\p_3$ have residue
degree~$1$ and~$\p_4$ has residue degree~$2$. We assume that the order defined
in Section~\ref{sec:primes} gives~$\p_1 < \p_2 < \p_3$. We first consider ideals
of norm~$p$. The only such ideals are~$\p_1$, $\p_2$ and~$\p_3$, and they have weight~$1$
and exponent vectors~$(1,0,0,0)$, $(0,1,0,0)$ and~$(0,0,1,0)$. Since
lexicographically we have~$(0,0,1,0)<(0,1,0,0)<(1,0,0,0)$, the reverse
lexicographic order gives~$\p_1<\p_2<\p_3$. Now
consider ideals of norm~$p^2$: $\p_4$, $\p_1^2$, $\p_2^2$, $\p_3^2$, $\p_1\p_2$,
$\p_1\p_3$ and~$\p_2\p_3$. The corresponding exponent vectors are~$(0,0,0,1)$,
$(2,0,0,0)$, $(0,2,0,0)$, $(0,0,2,0)$, $(1,1,0,0)$, $(1,0,1,0)$ and~$(0,1,1,0)$,
with weights~$1,2,2,2,2,2,2$. The order we defined is therefore~$\p_4 < \p_1^2 <
\p_1\p_2 < \p_1\p_3 < \p_2^2 < \p_2\p_3 < \p_3^2$. The reader can check that the
ideals of norm~$p^3$ are~$\p_4\p_1 < \p_4\p_2 < \p_4\p_3 < \p_1^3 < \p_1^2\p_2 <
\p_1^2\p_3 < \p_1\p_2^2 < \p_1\p_2\p_3 < \p_1\p_3^2 < \p_2^3 < \p_2^2\p_3 <
\p_2\p_3^2 < \p_3^3$.

\subsection{Arbitrary integral ideals}

We finally define an order on the set of all integral ideals. We first order
them by norm, so we only have to define an order on nonzero ideals of the same
norm. Let~$\a$ be an ideal of norm~$N = p_1^{a_1}\dots p_k^{a_k}$ with~$p_1 <
\dots < p_k$. Then~$\a$ has a unique factorization as~$\a = \a_1\dots\a_k$
where~$\a_i$ has norm~$p_i^{a_i}$. We order ideals of norm~$N$ according to the
lexicographic order of the $k$-uple~$(\a_1,\dots,\a_k)$.

Example: let~$K$ be a number field, and assume that~$2$ decomposes
as~$\p_1\p_2\p_3$ where~$\p_1<\p_2$ have residue degree~$1$ and~$\p_3$ has
residue degree~$2$, and that~$3$ decomposes as~$\q_1\q_2$ where~$\q_1$ has
degree~$1$ and~$\q_2$ has degree~$3$. Let us order ideals of norm~$18$. Such an
ideal is a product of an ideal of norm~$2$ and an ideal of norm~$9$. The ideals
of norm~$2$ are~$\p_1 < \p_2$, and the only ideal of norm~$9$ is~$\q_1^2$. The
ideals of norm~$18$ are therefore~$\p_1\q_1^2 < \p_2\q_1^2$. Let us now order ideals
of norm~$108 = 2^2\cdot 3^3$. The ideals of norm~$4$ are~$\p_3 < \p_1^2 < \p_1\p_2 <
\p_2^2$, and the ideals of norm~$27$ are~$\q_2 < \q_1^3$. The ideals of
norm~$108$ are therefore~$\p_3\q_2 < \p_3\q_1^3 < \p_1^2\q_2 < \p_1^2\q_1^3 <
\p_1\p_2\q_2 < \p_1\p_2\q_1^3 < \p_2^2\q_2 < \p_2^2\q_1^3$.

\section{Sorting isogenous elliptic curves}

\subsection{Elliptic curve labels}

Labels for elliptic curves over number fields (including $\Q$ have
three components: a label for the conductor, a label for each isogeny
class with that conductor, and a label for each curve in its isogeny
class.

Since conductors are integral ideals we can label them according to
the previous section.

For a fixed conductor each isogeny class is uniquely determined by the
traces of Frobenius $a_{\p}(E)$.  Here we include primes of bad
reduction in the usual way: $a_{\p}(E)=+1$ for split multiplicative
reduction, $-1$ for non-split and $0$ for additive reduction.  Now we
can sort the isogeny classes of any fixed conductor by
lexicographically ordering the sequence of $a_{\p}(E)$ with the
primes~$\p$ ordered as in the previous section.  Having done that,
each isogeny class has an index in the order; we base the indices
at~$0$ and convert to base 26 using ``digits'' $a=0$, $b=1$, $\dots$,
$z=25$, obtaining a string from the list $a, b, \dots, z, ba, bb,
\dots$.

Remarks: 1. In the LMFDB at present (June 2016) the isogeny class
labels follow this scheme for imaginary quadratic fields since there
the primes are sorted as in the previous section.  However the class
labels for elliptic curves over totally real fields are taken from the
labels of the associated Hilbert modular forms , whose ordering is not
necessary well-defined as described above.  This is a historical
accident.

2. Over $\Q$ the LMFDB labels for elliptic curves follow this but the
Cremona labels do not for conductors up to $230000$.  Again this is a
historical phenomenon.

Finally, the curves in each isogeny class are sorted in some way and
hence given a numerical index, starting at 1, which forms the third
part of the label.  In the rest of this section we describe methods
used to sort the curves in each isogeny class.

\subsection{Over \texorpdfstring{$\Q$}{\bf Q}}

Every elliptic curve over $\Q$ has a unique Weierstrass model which is
integral, globally minimal and with coefficients $a_1,a_3\in\{0,1\}$
and $a_3\in\{-1,0,1\}$.  We sort the curves using this coefficient
vector $(a_1,a_2,a_3,a_4,a_6)$.  In fact, within on isogeny class the
triple $(a_1,a_2,a_3)$ is constant\footnote{Siksek, Samir \textit{On
    standardized models of isogenous elliptic curves}. Math. Comp. 74
  (2005), no. 250, 949–951} so it suffices to sort on $(a_4,a_6)$.

This is the sorting used for the LMFDB labels for elliptic curves over
$\Q$.  It differs from the Cremona labelling, in which the ``strong
Weil'' or $\Gamma_0(N)$-optimal curve is number~$1$ and the others are
labelled in the order of being computed from the first.  At some point
the latter became completely deterministic and has been documented
elsewhere, but the details are not relevant here.

There are many reasons why a system of ordering isogenous curves using
Weierstrass models is hopeless over almost all number fields (the only
exceptions, perhaps, being the $7$ imaginary quadratic fields having
only $\pm1$ as units, and class number~$1$).  There may be no global
minimal model, in which case some ``semi-global minimal'' model is
stored in the LMFDB; even when there is a global minimal model,
scaling by units results in infinitely many such models, even up to
translation (except for imaginary quadratic fields where the number is
finite).

Instead we have devised a system of sorting isogenous curves which
does not depend on the model, based on the simple observation (see the
next subsection) that in almost all cases isogenous curves have
distinct $j$-invariants.  It would be possible to use this new system
over $\Q$, but as there are already two labelling systems we do not
propose this!

\subsection{Over arbitrary number fields}

The basic fact we need is that in almost all cases, the elliptic
curves in an isogeny class have distinct $j$-invariants.

\begin{thm}
Let $K$ be a number field and let $E_1$, $E_2$ elliptic curves defined
over~$K$ that are isogenous over $K$ but not isomorphic over $K$.
Then either
\begin{enumerate}
\item $j(E_1)\not=j(E_2)$; or
\item $E_1$ and $E_2$ both have CM by an imaginary quadratic order $\OO$
  of discriminant~$D<0$ for which $\sqrt{D}\notin K$ (so that the extra
  endomorphisms are not defined over~$K$), $E_1$ and $E_2$ become
  isomorphic over $L=K(\sqrt{D})$, and there is a rational cyclic isogeny $\phi\colon E_1\to E_2$
   of degree $|D|$ (if $D$ is odd), $|D|/4$
  (if $D$ is even and $D\not=-4$) or~$2$ (if $D=-4$).
\end{enumerate}
Conversely if $E$ is an elliptic curve defined over $K$ with CM by an
order of discriminant~$D$ not contained in~$K$, then the quadratic
twist of $E$ by $\sqrt{D}$ is isogenous but not isomorphic to~$E$
over~$K$; thus the isogeny class of $E$ consists of pairs of
curves, the curves in each pair being quadratic twists that are isomorphic
over $K(\sqrt{D})$ with CM by a quadratic order $\OO$ in that field (the
order $\OO$ is the same for each pair of quadratic twists but may vary across pairs).

\end{thm}

\begin{proof}
Let $\phi:E_1\to E_2$ be an isogeny defined over~$K$; without loss of
generality we may take $\phi$ to be cyclic (since otherwise it factors
through the multiplication-by-$m$ map $[m]$ on $E_1$ for some $m>1$).

Assume that $j(E_1)=j(E_2)$.  Then there is an isomorphism
$\alpha:E_2\to E_1$ defined over an extension $L/K$ of degree at
most~$6$, and no such isomorphism defined over $K$ itself, by
assumption.

The composite $\psi=\alpha\circ\phi$ is a cyclic endomorphism of $E_1$
of degree~${}>1$, which implies that $\End(E_1)\ne \Z$, so $E_1$ (and
therefore also $E_2$) has CM by some imaginary quadratic order~$\OO$, of
discriminant $D$, say.  Now $\psi$ is defined over $L=K(\sqrt{D})$,
and $L$ contains the field of definition of~$\alpha$, showing that
$[L:K]=2$ and that $\alpha$ is defined over~$L$.  Hence $E_1$ and
$E_2$ become isomorphic over the quadratic extension~$L$ of $K$.

Let $\sigma$ denote the nontrivial element of $\Gal(L/K)$.

Assume first that $j\not=0, 1728$, or equivalently that $D\not=-3,-4$.
Since the only nontrivial automorphism of $E_1$ is $[-1]$ it follows
that $\alpha^{\sigma}=-\alpha$, where $-\alpha=[-1]\circ\alpha$. Hence
$\psi^{\sigma}=-\psi$ (where again $-\psi=[-1]\circ\psi$).  Viewing
$\psi$ as an element of the abstract order~$\OO$, this means that
$\psi$ is ``pure imaginary''.  Moreover, the fact that $\psi$ has
cyclic kernel implies that $\psi$ is not divisible in~$\OO$ by any
integer $n>1$.  If $D$ is odd, so that $\OO=\Z[(1+\sqrt{D})/2]$, this
implies that $\psi=\pm\sqrt{D}$, so $\deg\psi=|D|$.  If $D$ is even
then $\OO=\Z[(1+\sqrt{D})/2]$ and $\psi=\pm\sqrt{D}/2$ with degree
$|D|/4$.

Suppose that $j=0$ and $D=-3$.  Without loss we may assume that $E_1$
has equation $Y^2=X^3+a$ with $a\in K^*$; since $E_2$ becomes
isomorphic to $E_1$ over the quadratic extension $K(\sqrt{-3})$, it is
isomorphic to $Y^2=X^3+a'$ where $a'/a$ represents a nontrivial
element of the kernel of the map $K^*/(K^*)^6 \to L^*/(L^*)^6$, but
the only such element (up to 6th powers) is $-27$ (easy exercise).
Hence without loss of generality $E_2$ has equation $Y^2=X^3-27a$, and
standard formulas show that $E_1$ and $E_2$ are $3$-isogenous.  To see
the last part directly, one isomorphism $E_1\to E_2$ is given by
$(x,y)\mapsto(-3x,-3\sqrt{-3}y)$ so that as in the generic case
$\alpha^{\sigma}=-\alpha$ and $\psi$ is pure imaginary, hence
$\psi=\pm\sqrt{-3}$ with degree~$3$.

Finally suppose that $j=1728$ and $D=-4$, so $L=K(\sqrt{-1})$.  The
kernel of $K^*/(K^*)^4 \to L^*/(L^*)^4$ has order~$2$ with non-trivial
element represented by~$-4$, and hence without loss of generality we
may suppose that $E_1$ has equation $Y^2=X^3+aX$ and $E_2:
Y^2=X^3-4aX$ for some $a\in K^*$.  Again it is well-known that these
are $2$-isogenous.  Alternatively, an explicit computation (similar to
that for $j=0$) shows that $\psi=\pm1\pm i$ with degree~$2$; note that
in this case $\alpha^{\sigma}\not=\pm\alpha$; instead,
$\alpha^{\sigma}=\epsilon\circ\alpha$ where $\epsilon\in\Aut(E_1)$ has
order~$4$.

For the last part, let $E$ have CM by the order $\OO$ of
discriminant~$D<0$ with $\sqrt{D}\notin K$.  Set $L=K(\sqrt{D})$ and
let $E'$ be the $\sqrt{D}$-twist of $E$.  Assume first that
$D\not=-4$; then $\OO$ contains a pure imaginary element $\psi$ which
when composed with an isomorphism $\alpha:E'\to E$ gives an isogeny
$\phi=\alpha\circ\psi:E_1\to E_2$, defined over~$K$.  For the case
$D=-4$, when $\sqrt{-1}\notin K$, we take an equation for $E$ of the
form $Y^2=X^3+aX$, set $E': Y^2=X^3-4aX$ and observe that $E$ and $E'$
are $2$-isogenous, not isomorphic over $K$ but isomorphic over
$K(\sqrt{-1})$ where $-4$ becomes a $4$th power.

\end{proof}

\subsection{Sorting isogenous elliptic curves over number fields}

The theorem in the last subsection says that, for any isogeny class of
curves defined over~$K$ which either do not have CM or which have
``rational CM'' (meaning that the extra endomorphisms are defined over
$K$ itself), the $j$-invariants of the curves in the class are
distinct; we may therefore sort the curves using their $j$-invariants
as in Section~1.

However, in the case where the curves in the isogeny class do have
rational CM, we adjust this sorting scheme as follows.  Observe that
when two elliptic curves are isogenous, if one has CM then so does the
other, and their endomorphism rings are (isomorphic to) orders in the
same imaginary quadratic field, though in general different orders.
In the case of rational CM, we first sort by the absolute value of the
CM discriminant; this means that curves which have the same
endomorphism ring are grouped together.  The number of isomorphism
classes in each of these ``clusters'' of curves is equal to the class
number of the associated CM discriminant.  Within each cluster, the
$j$-invariants are distinct, though Galois conjugate, and we sort them
as in Section~1.

It remains to consider isogeny classes of curves with CM by an order
in an imaginary quadratic field $\Q(\sqrt{d})$ where $\sqrt{d}\notin
K$.  As before, if any one curve in the isogeny class has this
property, then all $K$-isogenous curves also do, though they may have
CM by different orders in $\Q(\sqrt{d})$.  As in the rational CM case,
we first sort by the absolute value of the CM discriminant, and then
by the $j$-invariant, but now there will be exactly two curves for
which these are the same, which are $\sqrt{d}$-twists of each other.

Let $E_1$ and $E_2$ be $\sqrt{d}$-twists of each other with CM by the
same order in $\Q(\sqrt{d})$.  As we have seen, they are necessarily
isogenous over $K$ and in particular have the same conductor~$\n$.
Let $j=j(E_1)=j(E_2)$.  We may distinguish the curves using a prime
ideal $\p$ of $K$ with certain properties.  Consider the set of
primes~$\p$ of $K$ lying above a rational prime~$p$, such that
\begin{enumerate}
\item $p$ does not divide $6dN_{K/\Q}(\n)$;
\item $p$ does not divide $\disc g$, where $g$ is the defining polynomial
  of~$K$.
\item the Legendre symbol $(d/p)=-1$;
\item $\p$ has degree~$1$, and hence residue field~$\F_p$;
\item $\ord_{\p}(j-1728)=0$ if $j\not=1728$, otherwise $\ord_{\p}(j)=0$;
\end{enumerate}
Conditions (1), (2) and~(5) only exclude finitely many primes; (4)
excludes a set of density~$0$; and (3) still leaves a set of primes of
$K$ of density~$1/2$.  Using our ordering of primes we can let $\p$ be
the \textit{first} prime of $K$ with all the above properties, and
because of condition~(2), we only need use the simple form of ordering
of primes of equal norm based on the factorization of $g(X)$
modulo~$p$.  Note that the conditions we put on $\p$ are independent
of the models for $E_1$ and~$E_2$.

In the case $j\not=1728$, we can assume that $E_1$ and $E_2$ have
equations $Y^2=X^3+aX+b$ and $Y^2=X^3+d^2aX+d^3b$ respectively, with
$b\not=0$.  The conditions on $\p$ imply that the coefficients $a,b$
of the model for $E_1$ may be chosen so that $\p\nmid b$.  Hence
exactly one of $b$, $bd^3$ is a quadratic residue modulo~$\p$, and we
can use this distinction to order $E_1$ and~$E_2$.  In order to do
this without having to change models, take any integral model for
$E_1$ with invariants $c_4$, $c_6$ and $\Delta$, where
$j-1728=c_6^2/\Delta$; if $\p\nmid c_6$, which will be true unless the
model is non-minimal at~$\p$, we compute the Legendre symbol
$(c_6\pmod{\p}/p)=\pm1$ and put $E_1$ first if and only if the value
is $+1$.  In case our model is non-minimal at~$\p$, we will have
$\ord_{\p}(c_6)=6k$ and $\ord_{\p}(\Delta)=12k$ for some $k\ge1$.  Now
take $\pi$ a uniformiser at~$\p$ which has non-positive valuations at
all other primes and compute the symbol $(c_6/\pi^{6k}\pmod{\p}/p)$.
Clearly the resulting value $\pm1$ is independent of the choice of
model.

A similar analysis works when $j=1728$ using $c_4$ in place of $c_6$,
using the value of the Legendre symbol $(c_4/\pi^{4k}\pmod{\p}/p)$
where $\ord_{\p}(c_4)=4k\ge0$ and $c_4$ is the invariant of any
integral model for $E_1$.

This completes the task of sorting isogenous curves with the same
$j$-invariant in a model-independent way, and hence of sorting each
isogeny class of curves.  In summary, we sort the curves in each
isogeny class using as key the triple $(|D|,j,\epsilon)$ attached to
each elliptic curve $E$ in the isogeny class, where
\begin{itemize}
\item $D=\disc\End(E)$ (so $D<0$ if $E$ has CM, otherwise $D=1$);
\item $j=j(E)$, ordered as in Section~1;
\item $\epsilon\in\{-1,1\}$ is minus the value of the Legendre symbol
  defined above when $E$ has CM but not rational CM, and $\epsilon=0$
  otherwise.
\end{itemize}

\section{Minimal twists of elliptic curves}

\subsection{Basic notions}
Let $E$ be an elliptic curve defined over the number field~$K$.  The
twists of $E$ are the other elliptic curves $E'$ defined over~$K$ with
$j(E)=j(E')$, or equivalently such that $E$ and~$E'$ become isomorphic
over an extension of~$K$.

When $j(E)\not=0,1728$ all twists of $E$ are \textit{quadratic twists}
$E'=E^{(d)}$ which are isomorphic to~$E$ over quadratic
extensions~$K(\sqrt{d})/K$; these are parametrized by $K^*/(K^*)^2$.
For $j=1728$ and $j=0$, respectively, we must consider
\textit{quartic} and \textit{sextic} twists, parametrized
by~$K^*/(K^*)^4$ and $K^*/(K^*)^6$.  One can handle all these cases in
one by saying that the twists of~$E$ are parametrized by
$H^1(G_K,\Aut(E))$ where $G_K=\Gal(\Qbar/K)$, but here we will use the
more elementary language since we want to be as explicit as possible.

Our aim in this section is to define a \textit{minimal quadratic
  twist} for every elliptic curve, and also a \textit{minimal twist}
to cover the two exceptional $j$-invariants.  For $j(E)\not=0,1728$
the minimal quadratic twist of $E$ depends only on $j(E)$, so our
definition involves picking out a unique well-defined representative
curve with each $j$-invariant.

For minimal representatives with respect to the higher order twists,
we can simply pick out one curve with $j=0$ and one with $j=1728$. For
example, the curve with LMFDB label 27.a4 (Cremona label 27a3) has
$j=0$, minimal conductor~$27$ (among all elliptic curves defined
over~$\Q$ with $j(E)=0$) and minimal discriminant $-27$ (among all
curves $j(E)=0$ and conductor~$27$).  Similarly, 32.a3 (Cremona label
32a2 has minimal conductor $32$ and minimal discriminant $64$ among
those with $j(E)=1728$.  Nevertheless, we will also define minimal
quadratic twists for these $j$-invariants.

In general we require that the definition of which curve is the
minimal quadratic twist should depend only on the isomorphism class of
the curves and not on properties of the specific models used.  In many
cases it will suffice to consider the norms of the conductor~$\n$ and
of the \textit{minimal discriminant ideal}~$\d$ (defined below), but
we will need to examine further the situation where more than one
quadratic twist has the same values for both of these.

Recall that the minimal discriminant ideal is the integral ideal
$\prod\p^{d_{\p}}$ whose valuation at each prime~$\p$ is that of the
discriminant of the local minimal model at~$\p$.  For every
Weierstrass model of $E$ with discriminant $\Delta\in K^*$ we have
$(\Delta)=\n\u^{12}$ for some fractional ideal~$\u$, and for every
other Weierstrass model with discriminant~$\Delta'$ we have
$\Delta'/\Delta\in (K^*)^{12}$.  Hence the class of $\Delta$ modulo
$12$th powers is a well-defined invariant of~$E$, as is the ideal
class $[\u]$ of~$\u$.  This class is trivial if and only if $E$
possesses a global minimal model.

We first consider the case~$K=\Q$.

\subsection{Minimal quadratic twists over \texorpdfstring{$\Q$}{\textbf Q}}

We start by studying the situation where two elliptic curves $E_1$
and~$E_2$ defined over~$\Q$, which are quadratic twists by $d$, have
the same \textit{minimal discriminant}~$\Delta_{\text{min}}$.

\begin{prop} Let $E_1$ and $E_2$ be elliptic curves defined over~$\Q$
  which are non-isomorphic quadratic twists with the same minimal
  discriminant.  Then $E_2$ is the $-1$-twist of~$E_1$, and
  $j(E_1)=j(E_2)\not=1728$.
\end{prop}
\begin{proof}
Suppose that $E_2$ is the $d$-twist of $E_1$, where without loss of
generality $d$ is square-free, and $d\not=1$.  For a suitable choice
of Weierstrass models, the discriminants of~$E_1$ and~$E_2$ are
$\Delta_1$ and $\Delta_2=d^6\Delta_1$.  Since both sides are
well-defined modulo $12$th powers and
$\Delta_1\equiv\Delta_2\pmod{\Q^{\times 12}}$, it follows that $d^6$ is a
$12$th power, which implies that $d=\pm1$ (since $d$ is square-free)
and so $d=-1$.  For the last part, if $j(E_1)=j(E_2)=1728$, then with
the same models the ratio of the $c_4$-invariants is $d^2=1$, giving
$E_1\cong E_2$.  (In this case, $E_1$ is its own $-1$-twist.)
\end{proof}

Now fix a rational $j$-invariant $j$.  Among all elliptic curves $E$
defined over~$\Q$ with $j(E)=j$, there is a finite subset with minimal
conductor~$N$, and a subset of those for which
$\left|\Delta_{\text{min}}\right|$ is minimal.  If this subset
contains precisely one isomorphism class of curves, we define that to
be the minimal quadratic twist.  Otherwise, the proposition shows that
$j\not=1728$ and the subset contains precisely two curves which are
$-1$-twists of each other.  Now the ratio of their $c_6$-invariants,
which is well-defined modulo $6$th powers, is $(-1)^3=-1$, so exactly
one of the two curves has positive $c_6$, and we choose this one as
the minimal quadratic twist.

\begin{rem}
An alternative way to break the tie in the last situation, which is
similar to the system proposed above for sorting isogenous quadratic
twists, would be to take the first prime $p>3$ of good reduction and
congruent to~$3\pmod4$ and pick the curve for which $(c_6/p)=+1$.  The
method proposed here is simpler.
\end{rem}

In practice we can find the minimal quadratic twist of a curve $E$ as
follows.  Start with an integral short Weierstrass model
$Y^2=X^3+aX+b$ for $E$.  For each prime~$p$ dividing $\gcd(a,b)$, let
$k$ be maximal such that $p^{2k}\mid a$ and $p^{3k}\mid b$, and
replace $(a,b)$ by~$(a/p^{2k},b/p^{3k})$.  This gives a curve~$E_1$
which it is easy to see is the minimal twist of~$E$ at all
primes~$p>3$.  Now compute the $d$-twists of~$E_1$ for
$d\in\{\pm1,\pm2,\pm3,\pm6\}$, or just $d\in\{1,2,3,6\}$ if
$j(E)=1728$, and discard first those whose conductor is not minimal,
and then those whose minimal discriminant is non-minimal among the
curves still remaining. This will leave either one or two curves
remaining; in the latter case exactly one will have positive $c_6$, we
discard the other, and are left with the minimal quadratic twist.

\bibliographystyle{abbrv}
\begin{thebibliography}{10}
\bibitem{Roblot} David Ford, Sebastian Pauli and Xavier-Fran\c cois Roblot, {\em
  A fast algorithm for polynomial factorization over $\mathbb{Q}_p$}. J.
  Th\'eor. Nombres Bordeaux 14 (2002), no. 1, 151--169.
\bibitem{Janusz} Gerald J. Janusz, {\em Algebraic Number Fields} (2nd
  edition, 1996).  Graduate Studies in Mathematics Volume 7, American
  Mathematical Society, Providence, RI.
\end{thebibliography}
\end{document}
